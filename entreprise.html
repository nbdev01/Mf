<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Espace Entreprise</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
    input, button { padding: 8px; margin: 5px 0; }
    label { display: block; margin-top: 10px; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    .btn-supprimer { background-color: #dc3545; color: white; border: none; padding: 6px 10px; cursor: pointer; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    window.onload = () => {
      emailjs.init("pWkZyANEs1HISx4PQ");
      chargerChauffeurs();
    };
  </script>
</head>
<body>
  <h1>Espace Entreprise</h1>

  <label>Nom de l’entreprise :</label>
  <input type="text" id="entreprise" placeholder="ex: transvern" />

  <label>Adresse de l’entreprise :</label>
  <input type="text" id="adresse" placeholder="Adresse complète" />

  <label>Prénom du chauffeur :</label>
  <input type="text" id="prenom" placeholder="ex: Lucas" />

  <label>Nom du chauffeur :</label>
  <input type="text" id="nom" placeholder="ex: Dupont" />

  <label>Email du chauffeur :</label>
  <input type="email" id="email" placeholder="ex: lucas@email.com" />

  <button onclick="ajouterChauffeur()">Créer et envoyer l’accès</button>

  <h2>Liste des chauffeurs</h2>
  <table id="table-chauffeurs">
    <thead>
      <tr>
        <th>Nom complet</th>
        <th>Identifiant</th>
        <th>Email</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="liste-chauffeurs"></tbody>
  </table>

  <script>
    function ajouterChauffeur() {
      const prenom = document.getElementById("prenom").value.trim();
      const nom = document.getElementById("nom").value.trim();
      const email = document.getElementById("email").value.trim();
      const entreprise = document.getElementById("entreprise").value.trim().toLowerCase();
      const adresse = document.getElementById("adresse").value.trim();

      if (!prenom || !nom || !email || !entreprise) {
        alert("Merci de remplir tous les champs obligatoires.");
        return;
      }

      const identifiant = `${prenom.toLowerCase()}.${nom[0].toLowerCase()}.${entreprise}`;

      const chauffeur = { prenom, nom, email, identifiant, entreprise };

      // Sauvegarde locale
      let chauffeurs = JSON.parse(localStorage.getItem("chauffeurs")) || [];
      chauffeurs.push(chauffeur);
      localStorage.setItem("chauffeurs", JSON.stringify(chauffeurs));

      envoyerEmail(chauffeur);
      chargerChauffeurs();

      // Reset
      document.getElementById("prenom").value = "";
      document.getElementById("nom").value = "";
      document.getElementById("email").value = "";
    }

    function chargerChauffeurs() {
      const tbody = document.getElementById("liste-chauffeurs");
      tbody.innerHTML = "";
      const chauffeurs = JSON.parse(localStorage.getItem("chauffeurs")) || [];

      chauffeurs.forEach((ch, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ch.prenom} ${ch.nom}</td>
          <td>${ch.identifiant}</td>
          <td>${ch.email}</td>
          <td><button class="btn-supprimer" onclick="supprimerChauffeur(${index})">Supprimer</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function supprimerChauffeur(index) {
      let chauffeurs = JSON.parse(localStorage.getItem("chauffeurs")) || [];
      chauffeurs.splice(index, 1);
      localStorage.setItem("chauffeurs", JSON.stringify(chauffeurs));
      chargerChauffeurs();
    }

    function envoyerEmail(chauffeur) {
      const params = {
        prenom: chauffeur.prenom,
        identifiant: chauffeur.identifiant,
        entreprise: chauffeur.entreprise,
        email: chauffeur.email,
      };

      emailjs.send("service_uyvcs0c", "template_lqjfqh4", params)
        .then(() => {
          alert("Email envoyé à " + chauffeur.email);
        })
        .catch((error) => {
          console.error("Erreur lors de l'envoi du mail :", error);
          alert("Échec de l'envoi du mail.");
        });
    }
  </script>
</body>
</html>
